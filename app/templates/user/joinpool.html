{% extends 'base.html' %} 
{% block title %}Join Pool{% endblock %} 
{% block navigation %}
<a href="/userHome">My Pool</a>
<a href="/addPool">Add Pool</a>
<a href="/joinPool" id="activac">Join Pool</a>
<a href="/profile">Profile</a>
<a href="/logout">Logout</a>
{% endblock %} {% block content %}
<div class="search-container">
  <div class="search-box">
    <i class="fas fa-search"></i>
    <input type="text" id="searchInput" placeholder="Search by location..." />
  </div>
</div>

<div id="rideResults" class="ride-results">
  <!-- Ride results will be displayed here -->
</div>
{% endblock %} {% block extra_css %}
<style>
  .search-container {
    max-width: 600px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .search-box {
    position: relative;
    background: white;
    padding: 1rem;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  }

  .search-box i {
    position: absolute;
    left: 1.5rem;
    top: 50%;
    transform: translateY(-50%);
    color: #64748b;
  }

  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 5px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .search-box input:focus {
    outline: none;
    border-color: #004aad;
  }

  .ride-results {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin: 2rem;
    padding: 0 1rem;
  }

  .ride-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s;
  }

  .ride-card:hover {
    transform: translateY(-5px);
  }

  .ride-card h3 {
    color: #004aad;
    margin: 0 0 1rem 0;
    font-size: 1.2rem;
  }

  .ride-card p {
    margin: 0.5rem 0;
    color: #64748b;
  }

  .ride-card .btn {
    width: 100%;
    margin-top: 1rem;
    padding: 0.75rem;
    border: none;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .ride-card .btn-primary {
    background: #004aad;
    color: white;
  }

  .ride-card .btn-primary:hover {
    background: #003d8f;
  }
</style>
{% endblock %} {% block extra_js %}
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const userId = "{{ request.session.user_id }}";
    const userType = "{{ request.session.user_type }}";

    if (!userId || userType !== "user") {
      window.location.href = "/login";
      return;
    }

    // Initial load of rides
    searchRides();
  });

  function searchRides() {
    const searchInput = document.getElementById("searchInput");
    const userId = "{{ request.session.user_id }}";

    fetch(`/getJoinPool?search=${searchInput.value}&id=${userId}`)
      .then((response) => response.json())
      .then((data) => {
        const resultsDiv = document.getElementById("rideResults");
        let html = "";

        data.forEach((ride) => {
          html += `
            <div class="ride-card">
              <h3>${ride.fromCity} âžœ ${ride.toCity}</h3>
              <p><strong>Date:</strong> ${ride.datePoint}</p>
              <p><strong>Contact:</strong> ${ride.contactPoint}</p>
              <p><strong>Status:</strong> ${ride.status}</p>
              <button class="btn btn-primary" onclick="joinRide(${ride.id})">
                Join Ride
              </button>
            </div>
          `;
        });

        resultsDiv.innerHTML = html;
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }

  function joinRide(rideId) {
    if (confirm("Are you sure you want to join this ride?")) {
      fetch(`/joinRide/${rideId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/json",
        },
      })
        .then((response) => {
          if (response.ok) {
            window.location.reload();
          } else {
            alert("Failed to join ride. Please try again.");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An error occurred while joining the ride.");
        });
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
