<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Map from Current Location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .error-message {
            color: red;
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Route from Your Location</h1>
        <div id="map"></div>
        <div id="error" class="error-message"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        async function initMap() {
            const map = L.map('map').setView([51.505, -0.09], 13); // Default center (London)
            const errorDiv = document.getElementById('error');

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const urlParams = new URLSearchParams(window.location.search);
            const destination = urlParams.get('destination')?.trim();

            if (!destination) {
                errorDiv.textContent = 'Please provide a destination in the URL parameter (e.g., ?destination=Los+Angeles,CA).';
                return;
            }

            try {
                // Get user's current location
                const getCurrentLocation = () => {
                    return new Promise((resolve, reject) => {
                        if (!navigator.geolocation) {
                            reject(new Error('Geolocation is not supported by your browser.'));
                        }
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const coords = [position.coords.latitude, position.coords.longitude];
                                // Add marker for current location
                                L.marker(coords)
                                    .addTo(map)
                                    .bindPopup('Your Location')
                                    .openPopup();
                                resolve(coords);
                            },
                            (error) => {
                                let message;
                                switch (error.code) {
                                    case error.PERMISSION_DENIED:
                                        message = 'Location access denied. Please allow location access in your browser settings.';
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        message = 'Location information is unavailable.';
                                        break;
                                    case error.TIMEOUT:
                                        message = 'Location request timed out.';
                                        break;
                                    default:
                                        message = 'An unknown error occurred while retrieving location.';
                                }
                                reject(new Error(message));
                            },
                            { timeout: 10000, enableHighAccuracy: true }
                        );
                    });
                };

                // Geocode destination using Nominatim
                const geocode = async (query) => {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                    const data = await response.json();
                    if (data.length === 0) throw new Error(`Destination not found: ${query}`);
                    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                };

                // Get coordinates
                let sourceCoords;
                try {
                    sourceCoords = await getCurrentLocation();
                } catch (e) {
                    // Fallback to a default location (e.g., New York)
                    sourceCoords = [40.7128, -74.0060];
                    errorDiv.textContent = `${e.message} Using default location (New York) instead.`;
                    L.marker(sourceCoords)
                        .addTo(map)
                        .bindPopup('Default Location (New York)')
                        .openPopup();
                }

                const destCoords = await geocode(destination);

                // Center map on source
                map.setView(sourceCoords, 13);

                // Add routing control with waypoints
                L.Routing.control({
                    waypoints: [
                        L.latLng(sourceCoords[0], sourceCoords[1]),
                        L.latLng(destCoords[0], destCoords[1])
                    ],
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1'
                    }),
                    lineOptions: {
                        styles: [{ color: '#0078A8', weight: 4 }]
                    },
                    createMarker: (i, waypoint, n) => {
                        if (i === 1) { // Destination marker
                            return L.marker(waypoint.latLng)
                                .bindPopup('Destination: ' + destination);
                        }
                        return null; // No default marker for source (already added)
                    },
                    routeWhileDragging: false,
                    addWaypoints: false,
                    fitSelectedRoutes: true,
                    show: false // Hide default itinerary
                }).on('routingerror', (e) => {
                    errorDiv.textContent = 'Failed to load route: ' + (e.error.message || 'Unknown error');
                }).addTo(map);

            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>