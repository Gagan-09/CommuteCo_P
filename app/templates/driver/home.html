<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/static/css/all.css" />

    {%if messages%} {%for me in messages %} {%if me.tags in "success" %}
    <input type="hidden" value="{{me}}" id="successpoint" />

    {% endif %} {%if me.tags in "info" %}
    <input type="hidden" value="{{me}}" id="infoPoint" />
    {% endif %} {% endfor %} {% endif %}

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Driver Home</title>
  </head>

  <body>
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f4f6f8;
        margin: 0;
        padding: 0;
      }

      .headerSelction {
        background: #004aad;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .titlePoint {
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .navPoint {
        display: flex;
        gap: 1.5rem;
      }

      .navPoint a {
        color: white;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        transition: 0.3s;
      }

      .navPoint a:hover {
        background: #ffcc00;
        color: #000;
      }

      .navPoint a#activac {
        background: #ffcc00;
        color: #000;
      }

      .ride-cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        padding: 20px;
      }

      .ride-card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
        width: 300px;
        transition: transform 0.2s;
      }

      .ride-card:hover {
        transform: translateY(-5px);
      }

      h3 {
        font-size: 18px;
        margin-bottom: 10px;
      }

      p {
        font-size: 14px;
        margin-bottom: 8px;
      }

      .ride-actions {
        margin-top: 15px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      .accept-btn,
      .reject-btn,
      .check-balance-btn {
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .accept-btn {
        background-color: #4caf50;
        color: white;
      }

      .accept-btn:hover {
        background-color: #45a049;
      }

      .reject-btn {
        background-color: #f44336;
        color: white;
      }

      .reject-btn:hover {
        background-color: #e53935;
      }

      .check-balance-btn {
        background-color: #2196f3;
        color: white;
      }

      .check-balance-btn:hover {
        background-color: #1976d2;
      }

      .wallet-input {
        width: 100%;
        padding: 8px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }

      .balance-display {
        margin-top: 10px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
        font-size: 14px;
        display: none;
      }

      .balance-display.show {
        display: block;
      }
    </style>
    <div class="nothing" id="messagePoint"></div>
    <div class="headerSelction">
      <div class="titlePoint">CommuteCo</div>
      <div class="navPoint">
        <a href="/driverHome" id="activac">Available Rides</a>
        <a href="/acceptance/{{ request.session.driver_id }}/" id="activac"
          >Accepted Rides</a
        >
        <a href="/driver/transactions/" id="activac">Transactions</a>
        <a href="/logout" id="activac">Logout</a>
      </div>
    </div>
    <p
      style="
        font-size: large;
        font-size: 30px;
        padding-left: 20px;
        color: white;
        margin-top: 20px;
      "
    >
      Rides
    </p>

    <div class="ride-cards-container">
      {% for view in data %}
      <div class="ride-card">
        <form action="/stateOF/" method="post" id="acceptForm_{{view.id}}">
          {% csrf_token %}
          <h3>Ride #{{view.id}}</h3>
          <p><strong>Pickup Location:</strong> {{view.fromCity}}</p>
          <p><strong>Dropoff Location:</strong> {{view.toCity}}</p>
          <input type="hidden" name="rideId" value="{{view.id}}" />
          <input
            type="hidden"
            name="driverId"
            value="{{ request.session.driver_id }}"
          />
          <p><strong>Applied on :</strong> {{view.applyOn}}</p>
          <p><strong>Estimated Date:</strong> {{view.datePoint}}</p>

          <div class="wallet-section">
            <input
              type="text"
              class="wallet-input"
              placeholder="Enter your blockchain wallet address"
              name="walletAddress"
              required
            />
            <div class="balance-display" id="balance-{{view.id}}"></div>
          </div>

          <div class="ride-actions">
            <button
              type="button"
              class="check-balance-btn"
              onclick="checkBalance('{{view.id}}')"
            >
              Check Balance
            </button>
            <button
              type="button"
              class="reject-btn"
              onclick="rejectRide('{{view.id}}')"
            >
              Reject
            </button>
            <button
              type="button"
              class="accept-btn"
              onclick="acceptRide('{{view.id}}')"
            >
              Accept
            </button>
          </div>
        </form>
      </div>
      {% endfor %}
    </div>
  </body>

  {%if messages%}
  <script>
    const success = document.getElementById("successpoint")?.value || "";
    if (success.length != 0) {
      const vali = document.getElementById("messagePoint");
      vali.className = "dialog";
      vali.innerText = success;
      setTimeout(() => {
        vali.className = "nothing";
      }, 3000);
    }
  </script>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
  <script>
    // Initialize Web3 with Ganache
    const web3 = new Web3("http://127.0.0.1:7545");

    function checkBalance(rideId) {
      const form = document.getElementById(`acceptForm_${rideId}`);
      const walletInput = form.querySelector('input[name="walletAddress"]');
      const balanceDisplay = document.getElementById(`balance-${rideId}`);

      if (!walletInput.value) {
        alert("Please enter a wallet address");
        return;
      }

      if (!web3.utils.isAddress(walletInput.value)) {
        alert("Please enter a valid Ethereum wallet address");
        return;
      }

      balanceDisplay.textContent = "Checking balance...";
      balanceDisplay.classList.add("show");
      balanceDisplay.style.color = "#666";

      web3.eth
        .getBalance(walletInput.value)
        .then((balance) => {
          const ethBalance = web3.utils.fromWei(balance, "ether");
          balanceDisplay.textContent = `Wallet Balance: ${parseFloat(
            ethBalance
          ).toFixed(4)} ETH`;
          balanceDisplay.style.color = "#4CAF50";
        })
        .catch((error) => {
          balanceDisplay.textContent =
            "Error checking balance. Please try again.";
          balanceDisplay.style.color = "#f44336";
          console.error("Error checking balance:", error);
        });
    }

    function acceptRide(rideId) {
      const form = document.getElementById(`acceptForm_${rideId}`);
      const walletInput = form.querySelector('input[name="walletAddress"]');

      if (!walletInput.value) {
        alert("Please enter your wallet address first");
        return;
      }

      if (!web3.utils.isAddress(walletInput.value)) {
        alert("Please enter a valid Ethereum wallet address");
        return;
      }

      form.submit();
    }

    function rejectRide(rideId) {
      if (confirm("Are you sure you want to reject this ride?")) {
        const form = document.getElementById(`acceptForm_${rideId}`);
        const formData = new FormData();
        formData.append("rideId", rideId);
        formData.append("driverId", "{{ request.session.user_id }}");
        formData.append(
          "csrfmiddlewaretoken",
          form.querySelector("[name=csrfmiddlewaretoken]").value
        );

        fetch("/rejectRide/", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (response.ok) {
              const rideCard = document
                .getElementById(`acceptForm_${rideId}`)
                .closest(".ride-card");
              rideCard.style.display = "none";
            } else {
              alert("Error rejecting ride. Please try again.");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error rejecting ride. Please try again.");
          });
      }
    }
  </script>
</html>
